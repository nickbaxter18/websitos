name: PR Summary

on:
  workflow_run:
    workflows: ["Frontend CI", "Backend CI", "Coverage", "Render Deploy with Smoke Test", "Post-Deploy Smoke Tests"]
    types:
      - completed

jobs:
  pr-summary:
    runs-on: ubuntu-latest
    if: always()
    timeout-minutes: 15
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download frontend artifacts (ignore if missing)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: frontend-artifacts
          path: frontend-artifacts

      - name: Download backend artifacts (ignore if missing)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: backend-artifacts
          path: backend-artifacts

      - name: Download coverage artifacts (ignore if missing)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: coverage-frontend
          path: coverage-frontend

      - name: Download backend coverage artifacts (ignore if missing)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: coverage-backend
          path: coverage-backend

      - name: Download failure summaries (ignore if missing)
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: failure-summary
          path: failure-summaries

      - name: Generate PR Summary
        run: |
          echo "### âœ… CI & Deploy Summary" >> summary.md
          echo "- Frontend, Backend, Coverage, and Deploy jobs completed" >> summary.md
          echo "---" >> summary.md
          echo "### ðŸ“Š Coverage Reports" >> summary.md
          ls coverage-frontend || echo "(no frontend coverage found)" >> summary.md
          ls coverage-backend || echo "(no backend coverage found)" >> summary.md
          echo "---" >> summary.md
          echo "### ðŸš¨ Failure Summaries" >> summary.md
          for f in failure-summaries/*.md; do
            echo "\n" >> summary.md
            cat "$f" >> summary.md
            echo "\n" >> summary.md
          done || echo "No failure summaries found" >> summary.md

      - name: Post PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: workflow-report
          path: summary.md