name: PR Summary

on:
  workflow_run:
    workflows: ["Coverage Checks"]
    types:
      - completed

jobs:
  pr-summary:
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Download Coverage Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Generate PR Summary
        run: |
          echo "## ✅ CI Coverage Summary" > summary.md
          echo "| Area | Status | Coverage |" >> summary.md
          echo "|------|--------|----------|" >> summary.md

          for area in frontend backend backend-node e2e; do
            if [ -f artifacts/coverage-${area}/coverage-summary.json ]; then
              total=$(jq -r '.total.lines.pct' artifacts/coverage-${area}/coverage-summary.json)
              echo "| ${area} | ✅ Found | ${total}% |" >> summary.md
            else
              echo "| ${area} | ❌ Missing | N/A |" >> summary.md
              echo "::error::${area} coverage report missing"
            fi
          done

      - name: Post PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: coverage-summary
          path: summary.md