name: U-DIG IT Repo Sync

on:
  push:
    branches: [ main ]

jobs:
  sync:
    runs-on: ubuntu-latest
    environment: Websitos
    permissions:
      contents: read
    steps:
      - name: Verify EDITOR_API_KEY presence
        run: |
          if [ -z "${{ secrets.EDITOR_API_KEY }}" ]; then
            echo "‚ùå EDITOR_API_KEY not available"
            echo "::error file=.github/workflows/udigit-sync.yaml::EDITOR_API_KEY not available"
            exit 1
          else
            echo "‚úÖ EDITOR_API_KEY is available (masked)"
            echo "Length: ${#EDITOR_API_KEY}" # safe, does not reveal value
          fi
        env:
          EDITOR_API_KEY: ${{ secrets.EDITOR_API_KEY }}

      - name: Probe ingest API endpoint
        env:
          INGEST_API_URL: https://websitos2.onrender.com/ingest_file
        run: |
          echo "üîé Probing ingest API..."
          for i in 1 2 3; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$INGEST_API_URL" || echo "000")
            echo "Probe returned status: $STATUS"
            if [ "$STATUS" -eq 200 ]; then
              echo "‚úÖ Ingest API reachable"
              break
            fi
            echo "‚ö†Ô∏è Ingest API not reachable (status $STATUS). Retrying..."
            sleep $((5 * i))
          done
          if [ "$STATUS" -ne 200 ]; then
            echo "‚ö†Ô∏è Ingest API not reachable after retries (status $STATUS). Skipping sync."
            echo "::notice file=.github/workflows/udigit-sync.yaml::Ingest skipped because API unreachable"
            exit 0
          fi

      - name: Download repo archive
        run: |
          curl -L -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/zipball/${{ github.sha }} \
            -o repo.zip
          unzip repo.zip -d repo
          mv repo/* repo_extracted || true
          ls -la

      - name: Zip repo snapshot (excluding sensitive files)
        run: |
          zip -r repo-snapshot.zip repo_extracted \
            -x "*.git*" \
            -x ".env*" \
            -x "node_modules/*" \
            -x "venv/*" \
            -x "__pycache__/*"

      - name: Upload snapshot to U-DIG IT ingest API (with debug)
        env:
          INGEST_API_URL: https://websitos2.onrender.com/ingest_file
        run: |
          echo "üîé Sending request with EDITOR_API_KEY..."
          RESPONSE=$(curl -v -s -o response.txt -w "%{http_code}" -X POST "$INGEST_API_URL" \
            -H "x-api-key: ${{ secrets.EDITOR_API_KEY }}" \
            -F "file=@repo-snapshot.zip")

          echo "--- HTTP Status Code ---"
          echo "$RESPONSE"
          echo "--- HTTP Response Body ---"
          cat response.txt || echo "(no body)"

          if [ "$RESPONSE" -ne 200 ]; then
            echo "‚ö†Ô∏è U-DIG IT ingest API returned error (status $RESPONSE). Skipping without failing."
            echo "::notice file=.github/workflows/udigit-sync.yaml::Ingest skipped because API returned $RESPONSE"
            exit 0
          else
            echo "‚úÖ Sync successful"
          fi