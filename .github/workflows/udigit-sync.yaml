name: U-DIG IT Repo Sync

on:
  push:
    branches: [ main ]

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: read
      packages: read
    steps:
      - name: Checkout repo (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          show-progress: true
          persist-credentials: true

      - name: Verify GH_TOKEN presence
        run: |
          if [ -z "${{ secrets.GH_TOKEN }}" ]; then
            echo "‚ùå GH_TOKEN not available"
            exit 1
          else
            echo "‚úÖ GH_TOKEN is available (masked)"
          fi

      - name: Debug repo state
        run: |
          echo "üìÇ Listing files"
          ls -la || echo "‚ö†Ô∏è ls failed"

          echo "üîé Checking .git directory"
          ls -la .git || echo "‚ö†Ô∏è .git directory missing"

          echo "üîé Git HEAD"
          git rev-parse HEAD || echo "‚ö†Ô∏è rev-parse failed"

          echo "üîé Git status"
          git status || echo "‚ö†Ô∏è git status failed"

      - name: Zip repo snapshot (excluding sensitive files)
        run: |
          zip -r repo-snapshot.zip . \
            -x "*.git*" \
            -x ".env*" \
            -x "node_modules/*" \
            -x "venv/*" \
            -x "__pycache__/*"

      - name: Upload snapshot to U-DIG IT ingest API
        run: |
          RESPONSE=$(curl -s -o response.txt -w "%{http_code}" -X POST "https://websitos.onrender.com/ingest_file" \
            -H "Authorization: Bearer ${{ secrets.GH_TOKEN }}" \
            -F "file=@repo-snapshot.zip")

          echo "HTTP Response: $RESPONSE"
          cat response.txt

          if [ "$RESPONSE" -ne 200 ]; then
            echo "‚ùå U-DIG IT ingest API returned error"
            exit 1
          else
            echo "‚úÖ Sync successful"
          fi