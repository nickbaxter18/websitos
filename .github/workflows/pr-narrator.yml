name: PR Narrator Bot

on:
  workflow_run:
    workflows: ["CI Preflight", "Render Deploy with Smoke Test", "CCF Validation"]
    types:
      - completed

jobs:
  narrate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: Gather Logs
        run: |
          echo "Fetching logs for workflow run..."
          gh run download ${{ github.event.workflow_run.id }} --dir logs || true

      - name: Summarize Logs and Check Manifest
        id: summarize
        run: |
          echo "--- Workflow Summary ---" > summary.txt
          echo "Workflow: ${{ github.event.workflow_run.name }}" >> summary.txt
          echo "Status: ${{ github.event.workflow_run.conclusion }}" >> summary.txt
          echo "Diagnostics complete." >> summary.txt

      - name: Upload Narrator Summary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: narrator-summary
          path: summary.txt

      - name: Post PR Comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: workflow-report
          message: |
            ### üìù Workflow Report
            - Workflow: `${{ github.event.workflow_run.name }}`
            - Status: `${{ github.event.workflow_run.conclusion }}`

            **Summary:**
            ```
            $(cat summary.txt)
            ```

            ${{ github.event.workflow_run.conclusion != 'success' && '‚ùå Fix issues as described above.' || '‚úÖ Great work! Everything passed.' }}