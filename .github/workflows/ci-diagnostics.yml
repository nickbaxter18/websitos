name: CI Diagnostics

on:
  workflow_call:
    secrets:
      LINEAR_API_KEY:
        required: true
      LINEAR_TEAM_ID:
        required: true
  workflow_dispatch:

permissions:
  checks: write
  contents: read
  actions: read

jobs:
  diagnostics:
    name: Run CI Diagnostics
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create pending CI Diagnostics check
        uses: actions/github-script@v7
        with:
          script: |
            const { data: check } = await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: "CI Diagnostics",
              head_sha: process.env.GITHUB_SHA,
              status: "in_progress",
              output: {
                title: "CI Diagnostics Running",
                summary: "Diagnostics workflow has started."
              }
            });
            core.setOutput("check_id", check.id);

      - name: Debug info
        run: |
          echo "‚úÖ CI Diagnostics workflow triggered"
          echo "Commit: $GITHUB_SHA"
          echo "Branch: $GITHUB_REF_NAME"

      - name: Validate artifact presence
        id: validate
        run: |
          if [ ! -d "diagnostics-logs" ] || [ -z "$(ls -A diagnostics-logs 2>/dev/null || true)" ]; then
            echo "‚ùå No diagnostics logs were uploaded." >&2
            echo "logs_present=false" >> $GITHUB_OUTPUT
          else
            echo "logs_present=true" >> $GITHUB_OUTPUT
          fi

      - name: Guard against empty run
        if: steps.validate.outputs.logs_present == 'false'
        run: |
          echo "## CI Diagnostics Report" > report.md
          echo "No artifacts found for commit $GITHUB_SHA." >> report.md

      - name: Gather failure and warning summary
        id: classify
        run: |
          echo "## ‚ö†Ô∏è CI Diagnostics Report" > report.md
          echo "Commit: $GITHUB_SHA" >> report.md
          echo "Branch: $GITHUB_REF_NAME" >> report.md
          echo "---" >> report.md

          ERRORS=$(grep -iRE "(error|fail|exception|missing|denied)" diagnostics-logs || true | sort | uniq | head -n 500)
          WARNINGS=$(grep -iRE "(warn|warning|deprecated)" diagnostics-logs || true | sort | uniq | head -n 500)

          echo "error_count=$(echo "$ERRORS" | grep -c . || true)" >> $GITHUB_OUTPUT
          echo "warning_count=$(echo "$WARNINGS" | grep -c . || true)" >> $GITHUB_OUTPUT

          if [ -n "$ERRORS" ]; then
            echo "### ‚ùå Errors" >> report.md
            echo '```' >> report.md
            echo "$ERRORS" >> report.md
            echo '```' >> report.md
          fi
          if [ -n "$WARNINGS" ]; then
            echo "### ‚ö†Ô∏è Warnings" >> report.md
            echo '```' >> report.md
            echo "$WARNINGS" >> report.md
            echo '```' >> report.md
          fi

      - name: Sync Linear issue
        continue-on-error: true
        uses: actions/github-script@v7
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
          LINEAR_TEAM_ID: ${{ secrets.LINEAR_TEAM_ID }}
        with:
          script: |
            const fs = require('fs');

            if (!process.env.LINEAR_API_KEY || !process.env.LINEAR_TEAM_ID) {
              console.log("‚ùå Missing Linear secrets");
              fs.appendFileSync('report.md', `\n\n‚ùå Linear API key or team ID not configured.`);
              return;
            }

            const res = await fetch("https://api.linear.app/graphql", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${process.env.LINEAR_API_KEY}`
              },
              body: JSON.stringify({ query: "query { viewer { id name } }" })
            });
            const json = await res.json();
            console.log("Linear API test response:", JSON.stringify(json, null, 2));

            fs.appendFileSync('report.md', `\n\nüîó Linear API connectivity test: ${JSON.stringify(json)}`);

      - name: Complete CI Diagnostics check
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('report.md', 'utf8').slice(0, 60000);
            let conclusion = "success";
            if ('${{ steps.classify.outputs.error_count }}' !== '0') conclusion = "failure";
            else if ('${{ steps.classify.outputs.warning_count }}' !== '0') conclusion = "neutral";

            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: "CI Diagnostics",
              head_sha: process.env.GITHUB_SHA,
              status: "completed",
              conclusion,
              output: {
                title: "CI Diagnostics Report",
                summary
              }
            });