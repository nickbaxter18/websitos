name: CCF Validation

on:
  push:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * *' # run daily at 2am UTC
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Validate required files exist
        run: |
          CRITICAL_FILES=( \
            "config/secrets.schema.json" \
            "package.json" \
            "requirements.txt" \
            "tsconfig.json" \
            "jest.config.cjs" \
            ".github/workflows/branch-protection.yml" \
            ".github/workflows/render-deploy.yml" )

          OPTIONAL_FILES=( \
            ".github/ccf-manifest.md" \
            ".github/workflows/pr-summary.yml" \
            ".github/workflows/post-deploy-smoke.yml" )

          MISSING_CRITICAL=0
          for f in "${CRITICAL_FILES[@]}"; do
            if [ ! -f "$f" ]; then
              echo "‚ùå Missing critical file: $f"
              MISSING_CRITICAL=1
            else
              echo "‚úÖ Found critical file: $f"
            fi
          done

          for f in "${OPTIONAL_FILES[@]}"; do
            if [ ! -f "$f" ]; then
              echo "‚ö†Ô∏è Missing optional file: $f"
            else
              echo "‚úÖ Found optional file: $f"
            fi
          done

          if [ "$MISSING_CRITICAL" -eq 1 ]; then
            echo "‚ùå Critical files missing. Failing validation."
            exit 1
          else
            echo "‚úÖ Validation passed (optional files may be missing)."
          fi

      - name: Confirm manifest contains mapping section
        run: |
          if [ -f .github/ccf-manifest.md ] && grep -q "### üöÄ Mapping to Implementation" .github/ccf-manifest.md; then
            echo "‚úÖ Manifest mapping confirmed"
          else
            echo "‚ö†Ô∏è Manifest missing mapping section (not failing build)"
          fi