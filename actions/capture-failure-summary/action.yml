name: "Capture Failure Summary"
description: "Collects and emits failure info as annotations"
author: "websitos-ci"
runs:
  using: "composite"
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Emit failure annotations
      shell: bash
      run: |
        mkdir -p summary logs
        TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

        EXIT_CODE=$(cat exit_code.log 2>/dev/null || echo "unknown")
        ALL_STDERR=$(find logs -name "*.stderr.log" -exec tail -n 50 {} + 2>/dev/null || echo "No stderr captured")
        ALL_STDOUT=$(find logs -name "*.stdout.log" -exec tail -n 50 {} + 2>/dev/null || echo "No stdout captured")

        echo "::error::Job failed with exit code $EXIT_CODE"

        echo "$ALL_STDERR" | while read -r line; do
          if [ -n "$line" ]; then
            echo "::error::$line"
          fi
        done

        echo "$ALL_STDOUT" | while read -r line; do
          if [ -n "$line" ]; then
            echo "::warning::$line"
          fi
        done

        # Emit a final summary annotation
        echo "::notice::Failure summary recorded at $TIMESTAMP"