<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>U-Dig It File Editor</title>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
        background: #111;
        color: #eee;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }
      #sidebar {
        width: 260px;
        background: #1b1b1b;
        overflow-y: auto;
        border-right: 1px solid #333;
        padding: 10px;
        display: flex;
        flex-direction: column;
      }
      #fileSearch {
        padding: 6px;
        margin-bottom: 8px;
        font-size: 14px;
        width: 100%;
        border-radius: 4px;
        border: 1px solid #444;
        background: #222;
        color: #eee;
      }
      #main {
        flex: 1;
        display: flex;
        flex-direction: column;
      }
      header {
        background: #222;
        padding: 8px;
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      #tabs {
        display: flex;
        gap: 6px;
        overflow-x: auto;
        max-width: 55%;
      }
      .tab {
        padding: 4px 10px;
        background: #2b2b2b;
        border-radius: 6px 6px 0 0;
        cursor: pointer;
        font-size: 13px;
      }
      .tab.active {
        background: #444;
        font-weight: bold;
      }
      .close {
        margin-left: 6px;
        color: #aaa;
        cursor: pointer;
      }
      button {
        padding: 6px 10px;
        font-size: 13px;
        background: #2b2b2b;
        color: #eee;
        border: 1px solid #444;
        border-radius: 4px;
        cursor: pointer;
      }
      button:hover {
        background: #444;
      }
      .status {
        margin-left: auto;
        font-size: 12px;
        color: #aaa;
      }
      #editor {
        flex: 1;
      }
      .file,
      .dir {
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
        margin: 1px 0;
      }
      .file:hover,
      .dir:hover {
        background: #333;
      }
      .dir {
        font-weight: bold;
      }
      .nested {
        margin-left: 12px;
      }
      .hidden {
        display: none;
      }
    </style>
    <!-- âœ… CodeMirror CSS/JS -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/jsx/jsx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/markdown/markdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/htmlmixed/htmlmixed.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/json/json.min.js"></script>
  </head>
  <body>
    <div id="sidebar">
      <input type="text" id="fileSearch" placeholder="Search files..." />
      <div id="fileTree"></div>
    </div>
    <div id="main">
      <header>
        <div id="tabs"></div>
        <button onclick="saveFile()">ğŸ’¾ Save</button>
        <button onclick="promptNewFile()">ğŸ“„ New File</button>
        <button onclick="promptNewFolder()">ğŸ“‚ New Folder</button>
        <button onclick="promptDelete()">ğŸ—‘ Delete</button>
        <button onclick="promptMove()">âœ‚ï¸ Move</button>
        <button onclick="promptSearch()">ğŸ” Search</button>
        <button onclick="promptReplace()">ğŸ” Replace</button>
        <button onclick="tailLogs()">ğŸ“œ Tail Logs</button>
        <button onclick="startTask()">âš¡ Start Task</button>
        <button onclick="checkTaskStatus()">ğŸ›° Task Status</button>
        <button onclick="gitStatus()">ğŸŒ± Git Status</button>
        <div class="status" id="status">Idle</div>
      </header>
      <textarea id="editor"></textarea>
    </div>

    <script>
      const API_KEY = "1f82a9f4a9d84b8db2d4f6c0e2c5a7b1";

      async function authFetch(url, options = {}) {
        options.headers = Object.assign({}, options.headers, { "x-api-key": API_KEY });
        return fetch(url, options);
      }

      const editor = CodeMirror.fromTextArea(document.getElementById("editor"), {
        lineNumbers: true,
        theme: "dracula",
      });
      editor.setSize("100%", "100%");
      let openFiles = {},
        activeFile = null,
        lastTaskId = null;

      function detectMode(file) {
        if (!file) return "javascript";
        if (file.endsWith(".tsx") || file.endsWith(".jsx")) return "jsx";
        if (file.endsWith(".ts") || file.endsWith(".js")) return "javascript";
        if (file.endsWith(".json")) return "application/json";
        if (file.endsWith(".css")) return "css";
        if (file.endsWith(".html") || file.endsWith(".htm")) return "htmlmixed";
        if (file.endsWith(".md") || file.endsWith(".markdown")) return "markdown";
        if (file.endsWith(".xml")) return "xml";
        return "javascript";
      }

      async function loadTree(dir = ".") {
        const res = await authFetch("/list?dir=" + encodeURIComponent(dir));
        const data = await res.json();
        const container = document.createElement("div");
        data.files.forEach((f) => {
          const item = document.createElement("div");
          item.dataset.name = f.name.toLowerCase();
          item.dataset.type = f.type;
          if (f.type === "dir") {
            item.textContent = "ğŸ“‚ " + f.name;
            item.className = "dir";
            item.onclick = async () => {
              if (item.nextSibling && item.nextSibling.classList.contains("nested"))
                item.nextSibling.remove();
              else {
                const nested = await loadTree(data.dir + "/" + f.name);
                nested.classList.add("nested");
                item.after(nested);
              }
            };
          } else {
            item.textContent = "ğŸ“„ " + f.name;
            item.className = "file";
            item.onclick = () => openFile(data.dir + "/" + f.name);
          }
          container.appendChild(item);
        });
        return container;
      }

      async function renderSidebar() {
        const sidebar = document.getElementById("fileTree");
        sidebar.innerHTML = "";
        sidebar.appendChild(await loadTree("."));
      }

      async function openFile(path) {
        if (openFiles[path]) return setActiveTab(path);
        const res = await authFetch("/file?path=" + encodeURIComponent(path));
        if (!res.ok) return alert("File not found");
        const data = await res.json();
        const tab = document.createElement("div");
        tab.className = "tab";
        tab.textContent = path.split("/").pop();
        const closeBtn = document.createElement("span");
        closeBtn.textContent = "Ã—";
        closeBtn.className = "close";
        closeBtn.onclick = (e) => {
          e.stopPropagation();
          closeTab(path);
        };
        tab.appendChild(closeBtn);
        tab.onclick = () => setActiveTab(path);
        document.getElementById("tabs").appendChild(tab);
        openFiles[path] = { content: data.content, tabEl: tab };
        setActiveTab(path);
      }

      function setActiveTab(path) {
        if (activeFile && openFiles[activeFile]) {
          openFiles[activeFile].content = editor.getValue();
          openFiles[activeFile].tabEl.classList.remove("active");
        }
        activeFile = path;
        editor.setValue(openFiles[path].content);
        editor.setOption("mode", detectMode(path));
        openFiles[path].tabEl.classList.add("active");
        setStatus("Opened " + path);
      }

      function closeTab(path) {
        if (!openFiles[path]) return;
        const wasActive = activeFile === path;
        openFiles[path].tabEl.remove();
        delete openFiles[path];
        if (wasActive) {
          const next = Object.keys(openFiles)[0];
          if (next) setActiveTab(next);
          else {
            activeFile = null;
            editor.setValue("");
            setStatus("Idle");
          }
        }
      }

      async function saveFile() {
        if (!activeFile) return alert("No file open");
        const content = editor.getValue();
        const res = await authFetch("/file", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ path: activeFile, content }),
        });
        const data = await res.json();
        setStatus(data.message || "Saved!");
      }

      // === Cockpit Features ===
      async function promptNewFile() {
        const name = prompt("Enter new file path:");
        if (!name) return;
        const res = await authFetch("/create/file", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ path: name }),
        });
        const data = await res.json();
        setStatus(data.message);
        renderSidebar();
      }

      async function promptNewFolder() {
        const name = prompt("Enter new folder path:");
        if (!name) return;
        const res = await authFetch("/create/folder", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ path: name }),
        });
        const data = await res.json();
        setStatus(data.message);
        renderSidebar();
      }

      async function promptDelete() {
        const target = prompt("Enter file/folder path to delete:");
        if (!target) return;
        const res = await authFetch("/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ path: target, recursive: true }),
        });
        const data = await res.json();
        setStatus(data.message);
        renderSidebar();
      }

      async function promptMove() {
        const src = prompt("Enter source path:");
        if (!src) return;
        const dest = prompt("Enter destination path:");
        if (!dest) return;
        const res = await authFetch("/move", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ src, dest }),
        });
        const data = await res.json();
        setStatus(data.message);
        renderSidebar();
      }

      async function promptSearch() {
        const query = prompt("Enter search term:");
        if (!query) return;
        const res = await authFetch("/search?query=" + encodeURIComponent(query));
        const data = await res.json();
        alert(
          "Found " +
            data.matches.length +
            "\\n\\n" +
            data.matches.map((m) => `${m.path}:${m.line} â†’ ${m.text}`).join("\\n")
        );
        setStatus("Search complete");
      }

      async function promptReplace() {
        const query = prompt("Find what:");
        if (!query) return;
        const replace = prompt("Replace with:");
        if (replace === null) return;
        const res = await authFetch("/replace", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query, replace }),
        });
        const data = await res.json();
        setStatus(data.message || "Replace done");
      }

      async function tailLogs() {
        const logPath = prompt("Enter log file path:");
        if (!logPath) return;
        const res = await authFetch(`/logs/tail?path=${encodeURIComponent(logPath)}&lines=50`);
        const data = await res.json();
        alert("Last lines:\\n\\n" + (data.content || "No content"));
        setStatus("Log tailed");
      }

      async function startTask() {
        const cmd = prompt("Enter command to run:");
        if (!cmd) return;
        const res = await authFetch("/task/start", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ command: cmd }),
        });
        const data = await res.json();
        lastTaskId = data.taskId;
        alert("Task started with ID: " + lastTaskId);
        setStatus("Task started");
      }

      async function checkTaskStatus() {
        if (!lastTaskId) return alert("No task started yet");
        const res = await authFetch(`/task/status?taskId=${encodeURIComponent(lastTaskId)}`);
        const data = await res.json();
        alert(`Status: ${data.status}\\n\\nSTDOUT:\\n${data.stdout}\\n\\nSTDERR:\\n${data.stderr}`);
        setStatus("Task checked");
      }

      async function gitStatus() {
        const res = await authFetch("/git/status");
        const data = await res.json();
        alert(data.stdout || data.stderr || "No output");
        setStatus("Git status checked");
      }

      function setStatus(msg) {
        document.getElementById("status").innerText = msg;
      }

      document.getElementById("fileSearch").addEventListener("input", (e) => {
        const term = e.target.value.toLowerCase();
        document.querySelectorAll("#fileTree .file, #fileTree .dir").forEach((el) => {
          if (el.dataset.name.includes(term)) el.classList.remove("hidden");
          else el.classList.add("hidden");
        });
      });

      renderSidebar();
    </script>
  </body>
</html>
